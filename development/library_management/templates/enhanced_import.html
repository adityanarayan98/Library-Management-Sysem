{% extends "base.html" %}

{% block title %}Enhanced Import - Library Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="mb-0"><i class="bi bi-cloud-arrow-up me-2"></i>Enhanced Data Import</h1>
                <p class="text-muted mb-0">Import data with validation and one-by-one processing</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Import Type Selection -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Data Import</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <!-- Import Type Selection -->
                        <div class="mb-4">
                            <label for="import_type" class="form-label">Select Data Type to Import</label>
                            <select class="form-select form-select-lg" id="import_type" name="import_type" required onchange="updateFileFormat()">
                                <option value="">Choose data type...</option>
                                <option value="patrons">Patrons Data</option>
                                <option value="books">Books Collection</option>
                                <option value="transactions">Transactions History</option>
                                <option value="categories">Categories & Settings</option>
                            </select>
                            <div class="form-text">Select the type of data you want to import</div>
                        </div>

                        <!-- File Upload -->
                        <div class="mb-4" id="file_upload_section" style="display: none;">
                            <label for="file" class="form-label">Select CSV File</label>
                            <input type="file" class="form-control form-control-lg" id="file" name="file" accept=".csv" required>
                            <div class="form-text">Upload a CSV file exported from backup or another system</div>
                        </div>

                        <!-- Expected Format Info -->
                        <div class="mb-4" id="format_info" style="display: none;">
                            <h6>Expected CSV Format:</h6>
                            <div id="format_details" class="bg-light p-3 rounded">
                                <small class="text-muted">Select data type above to see format requirements</small>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mb-3" id="action_buttons" style="display: none;">
                            <button type="submit" name="action" value="validate" class="btn btn-info btn-lg me-2">
                                <i class="bi bi-check-circle me-2"></i>Validate & Preview
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reset
                            </button>
                        </div>
                    </form>

                    <!-- Import Button (shown after validation) -->
                    <div id="import_button_section" style="display: none;">
                        <hr class="my-4">
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="import_type" id="hidden_import_type"/>
                            <input type="hidden" name="action" value="import"/>
                            <button type="submit" class="btn btn-success btn-lg" onclick="return confirmImport()">
                                <i class="bi bi-cloud-upload me-2"></i>Import Validated Data
                            </button>
                        </form>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="editImport()">
                            <i class="bi bi-pencil me-2"></i>Edit Selection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Summary -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Import Summary</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <h5 class="mt-3">Controlled Import Process</h5>
                        <p class="text-muted small">Validate first, then import with full control</p>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-1" id="total_records">0</h4>
                                <small class="text-muted">Total Records</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-1" id="valid_records">0</h4>
                            <small class="text-muted">Valid Records</small>
                        </div>
                    </div>

                    <hr class="my-3">

                    <h6>Import Process:</h6>
                    <ol class="list-unstyled small">
                        <li><i class="bi bi-check-circle text-muted me-2"></i>Select data type</li>
                        <li><i class="bi bi-check-circle text-muted me-2"></i>Upload CSV file</li>
                        <li><i class="bi bi-check-circle text-muted me-2"></i>Validate data structure</li>
                        <li><i class="bi bi-check-circle text-muted me-2"></i>Review preview</li>
                        <li><i class="bi bi-check-circle text-muted me-2"></i>Import with confirmation</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Validation Errors -->
    {% if validation_errors %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Validation Errors</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <ul class="mb-0">
                            {% for error in validation_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Preview Data -->
    {% if preview_data %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Data Preview</h5>
                    <span class="badge bg-success">Ready for Import</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Row</th>
                                    {% if preview_data and preview_data[0].get('roll_no') %}<th>Roll No</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('name') %}<th>Name</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('title') %}<th>Title</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('author') %}<th>Author</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('accession_number') %}<th>Accession No</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('patron_id') %}<th>Patron ID</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('book_id') %}<th>Book ID</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('issue_date') %}<th>Issue Date</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('due_date') %}<th>Due Date</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('email') %}<th>Email</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('phone') %}<th>Phone</th>{% endif %}
                                    {% if preview_data and preview_data[0].get('isbn') %}<th>ISBN</th>{% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in preview_data %}
                                <tr>
                                    <td><span class="badge bg-secondary">{{ item.row }}</span></td>
                                    {% if item.get('roll_no') %}<td>{{ item.roll_no }}</td>{% endif %}
                                    {% if item.get('name') %}<td>{{ item.name }}</td>{% endif %}
                                    {% if item.get('title') %}<td>{{ item.title }}</td>{% endif %}
                                    {% if item.get('author') %}<td>{{ item.author }}</td>{% endif %}
                                    {% if item.get('accession_number') %}<td>{{ item.accession_number }}</td>{% endif %}
                                    {% if item.get('patron_id') %}<td>{{ item.patron_id }}</td>{% endif %}
                                    {% if item.get('book_id') %}<td>{{ item.book_id }}</td>{% endif %}
                                    {% if item.get('issue_date') %}<td>{{ item.issue_date }}</td>{% endif %}
                                    {% if item.get('due_date') %}<td>{{ item.due_date }}</td>{% endif %}
                                    {% if item.get('email') %}<td>{{ item.email }}</td>{% endif %}
                                    {% if item.get('phone') %}<td>{{ item.phone }}</td>{% endif %}
                                    {% if item.get('isbn') %}<td>{{ item.isbn }}</td>{% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Preview Mode:</strong> Above data has been validated and is ready for import.
                        Click "Import Validated Data" to proceed with the actual import.
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Import Results -->
    {% if import_results %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card {% if import_results.success %}border-success{% else %}border-danger{% endif %}">
                <div class="card-header {% if import_results.success %}bg-success{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-{% if import_results.success %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
                        Import {% if import_results.success %}Completed{% else %}Failed{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if import_results.success %}
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h4 class="text-success mb-1">{{ import_results.imported }}</h4>
                            <small class="text-muted">Records Imported</small>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-primary mb-1">{{ import_results.total_processed }}</h4>
                            <small class="text-muted">Total Processed</small>
                        </div>
                        <div class="col-md-4">
                            <h4 class="text-info mb-1">{{ import_results.total_processed - import_results.imported }}</h4>
                            <small class="text-muted">Skipped/Updated</small>
                        </div>
                    </div>
                    {% if import_results.errors %}
                    <hr class="my-3">
                    <h6>Import Notes:</h6>
                    <ul class="text-warning small">
                        {% for error in import_results.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-danger">
                        <strong>Import Failed:</strong> {{ import_results.error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Import Guidelines -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Import Guidelines</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle text-success me-2"></i>Supported Data Types:</h6>
                            <ul class="list-unstyled">
                                <li><strong>Patrons:</strong> roll_no, name, email, phone, patron_type, department, division, status, max_books</li>
                                <li><strong>Books:</strong> title, author, isbn, publisher, publication_year, accession_number, category</li>
                                <li><strong>Transactions:</strong> patron_id, book_id, issue_date, due_date, return_date, status, fine_amount</li>
                                <li><strong>Categories:</strong> name, description, is_active</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-exclamation-triangle text-warning me-2"></i>Important Notes:</h6>
                            <ul class="list-unstyled">
                                <li>• Files are validated before import</li>
                                <li>• Existing records are updated, new ones are created</li>
                                <li>• Invalid records are skipped with error reporting</li>
                                <li>• Import process can be stopped and resumed</li>
                                <li>• Always backup your data before importing</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateFileFormat() {
    const importType = document.getElementById('import_type').value;
    const fileUploadSection = document.getElementById('file_upload_section');
    const formatInfo = document.getElementById('format_info');
    const formatDetails = document.getElementById('format_details');
    const actionButtons = document.getElementById('action_buttons');
    const importButtonSection = document.getElementById('import_button_section');

    // Hide all sections initially
    fileUploadSection.style.display = 'none';
    formatInfo.style.display = 'none';
    actionButtons.style.display = 'none';
    importButtonSection.style.display = 'none';

    if (importType) {
        fileUploadSection.style.display = 'block';
        formatInfo.style.display = 'block';
        actionButtons.style.display = 'block';

        // Update format details based on selected type
        let formatText = '';
        switch(importType) {
            case 'patrons':
                formatText = '<strong>Required:</strong> roll_no, name<br>' +
                           '<strong>Optional:</strong> email, phone, patron_type, department, division, status, max_books<br>' +
                           '<em>Example: CS001, John Doe, john@email.com, 1234567890</em>';
                break;
            case 'books':
                formatText = '<strong>Required:</strong> title, author, accession_number<br>' +
                           '<strong>Optional:</strong> isbn, publisher, publication_year, category<br>' +
                           '<em>Example: Introduction to Python, John Smith, 12345</em>';
                break;
            case 'transactions':
                formatText = '<strong>Required:</strong> patron_id, book_id, issue_date, due_date<br>' +
                           '<strong>Optional:</strong> return_date, status, fine_amount<br>' +
                           '<em>Example: 1, 5, 2024-01-15, 2024-01-30</em>';
                break;
            case 'categories':
                formatText = '<strong>Required:</strong> name<br>' +
                           '<strong>Optional:</strong> description, is_active<br>' +
                           '<em>Example: Computer Science, Study of algorithms and data structures</em>';
                break;
        }
        formatDetails.innerHTML = formatText;
    }
}

function resetForm() {
    document.getElementById('import_type').value = '';
    document.getElementById('file').value = '';
    updateFileFormat();

    // Hide preview and results sections
    const previewCards = document.querySelectorAll('.card');
    previewCards.forEach(card => {
        const header = card.querySelector('.card-header');
        if (header && header.textContent.includes('Data Preview')) {
            card.style.display = 'none';
        }
    });
}

function confirmImport() {
    const importType = document.getElementById('import_type').value;
    const validRecords = document.getElementById('valid_records').textContent;

    return confirm(`Are you sure you want to import ${validRecords} ${importType} records?\n\nThis action cannot be undone.`);
}

function editImport() {
    const importButtonSection = document.getElementById('import_button_section');
    const actionButtons = document.getElementById('action_buttons');

    importButtonSection.style.display = 'none';
    actionButtons.style.display = 'block';

    // Scroll to top of form
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Update counters when preview data is available
{% if preview_data %}
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('total_records').textContent = '{{ preview_data|length }}';
    document.getElementById('valid_records').textContent = '{{ preview_data|length }}';

    // Show import button section
    document.getElementById('import_button_section').style.display = 'block';
    document.getElementById('hidden_import_type').value = document.getElementById('import_type').value;
});
{% endif %}
</script>
{% endblock %}
